@page "/game/"
@page "/game/{Uuid}"
@rendermode InteractiveServer
@inject NavigationManager NavigationManager
@inject GameService GameService
@using TourDeApp.Components.Pages.Shared
@inject IJSRuntime JSRuntime

<PageTitle>Game</PageTitle>

@if (_game != null && _game.GameFinished != true)
{
    <div class="game">
        <GameField Game="_game" OnWin="StateHasChanged"></GameField>
    </div>
}
else
{
    <!-- TODO: Display a message saying who has won, how many rounds, etc. -->
}

@code



{
    private TourDeApp.Models.Game? _game { get; set; }
    [Parameter] public string Uuid { get; set; }
    
    protected override void OnInitialized()
    {

    }

    protected override async Task OnInitializedAsync()
    {
        await Task.Delay(50); // Allow SignalR connection to fully initialize
        _game = GameService.CreateGame();

        if (Uuid == null)
        {
            Uuid = _game.Uuid;

            // Ensure component is ready before navigation
            await InvokeAsync(async () =>
            {
                await Task.Delay(1);
                await JSRuntime.InvokeVoidAsync("console.log", "This is a message from Blazor!");
                NavigationManager.NavigateTo($"/game/{Uuid}", true);
            });
        }
        else
        {
            _game = GameService.GetCurrentGame();
            StateHasChanged();
        }
    }

}
